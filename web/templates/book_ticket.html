{% extends "base.html" %}

{% block title %}Select Seats - {{ movie.title }} - Sydney Cinema Booking System{% endblock %}

{% block content %}
<div class="seat-selection-section">
    <div class="container">
        <div class="row">
            <!-- Movie Info Sidebar -->
            <div class="col-md-4">
                <div class="movie-info-card">
                    <div class="movie-poster">
                        <img src="{{ movie.poster_url or 'https://via.placeholder.com/300x450?text=No+Poster' }}" 
                             alt="{{ movie.title }} Poster" class="img-fluid">
                    </div>
                    
                    <div class="movie-details">
                        <h3>{{ movie.title }}</h3>
                        <p class="movie-genre">{{ movie.genre }}</p>
                        <p class="movie-rating">{{ movie.rating }}</p>
                        <p class="movie-duration">{{ movie.get_duration_formatted() }}</p>
                        
                        <div class="cinema-info">
                            <h5>{{ cinema.cinema_name }}</h5>
                            <p>{{ cinema.address }}</p>
                            <p>{{ cinema.suburb }}, {{ cinema.state }} {{ cinema.postcode }}</p>
                        </div>
                        
                        <div class="screening-info">
                            <h5>Screening Details</h5>
                            <p><strong>Date:</strong> {{ screening.get_date_formatted() }}</p>
                            <p><strong>Time:</strong> {{ screening.get_time_formatted() }}</p>
                            <p><strong>Hall:</strong> {{ hall.hall_name }}</p>
                            <p><strong>Type:</strong> {{ hall.hall_type }}</p>
                            {% if hall.screen_size %}
                            <p><strong>Screen:</strong> {{ hall.screen_size }}</p>
                            {% endif %}
                        </div>
                        
                        <div class="price-info">
                            <h5>Pricing</h5>
                            <p><strong>Base Price:</strong> ${{ "%.2f"|format(screening.ticket_price|float) }}</p>
                            <div class="seat-types">
                                <div class="seat-type-item">
                                    <span class="seat-icon standard"></span>
                                    <span>Standard: ${{ "%.2f"|format(screening.ticket_price|float) }}</span>
                                </div>
                                <div class="seat-type-item">
                                    <span class="seat-icon premium"></span>
                                    <span>Premium: ${{ "%.2f"|format((screening.ticket_price|float) * 1.5) }}</span>
                                </div>
                                <div class="seat-type-item">
                                    <span class="seat-icon vip"></span>
                                    <span>VIP: ${{ "%.2f"|format((screening.ticket_price|float) * 2.0) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Seat Selection Area -->
            <div class="col-md-8">
                <div class="seat-selection-card">
                    <div class="seat-selection-header">
                        <h2><i class="fas fa-chair me-2"></i>Select Your Seats</h2>
                        <p>Click on available seats to select them</p>
                    </div>
                    
                    <div class="cinema-screen">
                        <div class="screen-label">SCREEN</div>
                    </div>
                    
                    <div class="seat-map-container">
                        <div id="seatMap" class="seat-map">
                            <!-- Seat map will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="seat-legend">
                        <div class="legend-item">
                            <span class="seat-icon available"></span>
                            <span>Available</span>
                        </div>
                        <div class="legend-item">
                            <span class="seat-icon selected"></span>
                            <span>Selected</span>
                        </div>
                        <div class="legend-item">
                            <span class="seat-icon occupied"></span>
                            <span>Occupied</span>
                        </div>
                        <div class="legend-item">
                            <span class="seat-icon disabled"></span>
                            <span>Disabled</span>
                        </div>
                    </div>
                    
                    <div class="booking-summary">
                        <div class="selected-seats">
                            <h5>Selected Seats:</h5>
                            <div id="selectedSeatsList"></div>
                        </div>
                        
                        <div class="total-price">
                            <h5>Total Price:</h5>
                            <div class="price-display">
                                <span id="totalPrice">$0.00</span>
                            </div>
                        </div>
                        
                        <div class="booking-actions">
                            <button id="bookButton" class="btn btn-primary btn-lg" disabled>
                                <i class="fas fa-credit-card me-2"></i>Complete Booking
                            </button>
                            <a href="{{ url_for('movie_detail', movie_id=movie.movie_id) }}" class="btn btn-outline-secondary btn-lg">
                                <i class="fas fa-arrow-left me-2"></i>Back to Movie
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden form for booking -->
<form id="bookingForm" method="POST" action="{{ url_for('api_book_ticket') }}" style="display: none;">
    <input type="hidden" name="screening_id" value="{{ screening.screening_id }}">
    <input type="hidden" name="selected_seats" id="selectedSeatsInput">
    <input type="hidden" name="total_amount" id="totalAmountInput">
</form>
{% endblock %}

{% block extra_css %}
<style>
.seat-selection-section {
    padding: 40px 0;
    background: linear-gradient(135deg, var(--primary-dark) 0%, #000 100%);
    min-height: calc(100vh - 150px);
}

.movie-info-card {
    background-color: var(--card-bg);
    border-radius: 15px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
    border: 1px solid var(--border-color);
    overflow: hidden;
    margin-bottom: 20px;
}

.movie-poster img {
    width: 100%;
    height: auto;
    border-radius: 10px;
}

.movie-details {
    padding: 20px;
    color: var(--text-light);
}

.movie-details h3 {
    color: var(--accent-gold);
    margin-bottom: 10px;
}

.movie-details p {
    margin-bottom: 5px;
    color: var(--text-light);
}

.cinema-info, .screening-info, .price-info {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
}

.cinema-info h5, .screening-info h5, .price-info h5 {
    color: var(--accent-gold);
    margin-bottom: 10px;
}

.seat-types {
    margin-top: 10px;
}

.seat-type-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.seat-icon {
    width: 20px;
    height: 20px;
    border-radius: 3px;
    margin-right: 10px;
    display: inline-block;
}

.seat-icon.standard {
    background-color: #6c757d;
}

.seat-icon.premium {
    background-color: #ffc107;
}

.seat-icon.vip {
    background-color: #dc3545;
}

.seat-selection-card {
    background-color: var(--card-bg);
    border-radius: 15px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
    border: 1px solid var(--border-color);
    overflow: hidden;
}

.seat-selection-header {
    background: linear-gradient(90deg, var(--accent-gold), #e6b800);
    color: var(--primary-dark);
    padding: 25px;
    text-align: center;
}

.seat-selection-header h2 {
    margin: 0;
    font-weight: bold;
}

.cinema-screen {
    background: linear-gradient(90deg, #333, #666, #333);
    height: 60px;
    margin: 20px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.screen-label {
    color: var(--accent-gold);
    font-weight: bold;
    font-size: 1.2rem;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
}

.seat-map-container {
    padding: 20px;
    max-height: 500px;
    overflow-y: auto;
}

.seat-map {
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: center;
}

.seat-row {
    display: flex;
    gap: 4px;
    align-items: center;
}

.row-label {
    width: 30px;
    text-align: center;
    color: var(--accent-gold);
    font-weight: bold;
    font-size: 0.9rem;
}

.seat {
    width: 30px;
    height: 30px;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: bold;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.seat.available {
    background-color: #28a745;
    color: white;
}

.seat.available:hover {
    background-color: #218838;
    transform: scale(1.1);
}

.seat.selected {
    background-color: var(--accent-gold);
    color: var(--primary-dark);
    border-color: #e6b800;
}

.seat.occupied {
    background-color: #dc3545;
    color: white;
    cursor: not-allowed;
}

.seat.disabled {
    background-color: #6c757d;
    color: #adb5bd;
    cursor: not-allowed;
}

.seat.standard {
    border-color: #6c757d;
}

.seat.premium {
    border-color: #ffc107;
}

.seat.vip {
    border-color: #dc3545;
}

.seat-legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    padding: 20px;
    background-color: var(--secondary-dark);
    border-top: 1px solid var(--border-color);
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-light);
}

.seat-icon.available {
    background-color: #28a745;
}

.seat-icon.selected {
    background-color: var(--accent-gold);
}

.seat-icon.occupied {
    background-color: #dc3545;
}

.seat-icon.disabled {
    background-color: #6c757d;
}

.booking-summary {
    padding: 20px;
    background-color: var(--secondary-dark);
    border-top: 1px solid var(--border-color);
}

.selected-seats, .total-price {
    margin-bottom: 20px;
}

.selected-seats h5, .total-price h5 {
    color: var(--accent-gold);
    margin-bottom: 10px;
}

.price-display {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--accent-gold);
}

.booking-actions .btn {
    margin: 10px;
    padding: 12px 30px;
    font-size: 1.1rem;
    border-radius: 30px;
}

.btn-primary {
    background-color: var(--button-primary-bg);
    color: var(--button-primary-text);
    border: none;
}

.btn-primary:hover {
    background-color: #e6b800;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
}

.btn-primary:disabled {
    background-color: var(--text-muted);
    color: var(--primary-dark);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.selected-seat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background-color: var(--secondary-dark);
    border-radius: 5px;
    margin-bottom: 5px;
    border: 1px solid var(--border-color);
}

.selected-seat-item .seat-label {
    font-weight: bold;
    color: var(--accent-gold);
}

.selected-seat-item .seat-type {
    color: var(--text-light);
    font-size: 0.9rem;
}

.selected-seat-item .seat-price {
    color: var(--accent-gold);
    font-weight: bold;
}

.seat-map-error {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-light);
}

.seat-map-error i {
    font-size: 3rem;
    color: var(--accent-gold);
    margin-bottom: 20px;
}

.seat-map-error p {
    font-size: 1.2rem;
    margin-bottom: 20px;
}

.seat-map-error .btn {
    padding: 10px 20px;
    border-radius: 25px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const screeningId = {{ screening.screening_id }};
    const basePrice = {{ screening.ticket_price|float }};
    let selectedSeats = [];
    
    // Load seat map
    loadSeatMap();
    
    function loadSeatMap() {
        fetch(`/api/seats/${screeningId}`, {
            credentials: 'include'
        })
            .then(response => {
                if (response.status === 401) {
                    showSeatMapError('Please login to view seat map.');
                    return;
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.success) {
                    renderSeatMap(data.seat_map, data.occupied_seats);
                } else {
                    console.error('Failed to load seat map:', data ? data.error : 'No data');
                    showSeatMapError('Failed to load seat map: ' + (data ? data.error : 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error loading seat map:', error);
                // Check if response is HTML (login page)
                if (error.message.includes('Unexpected token')) {
                    showSeatMapError('Please login to view seat map.');
                } else {
                    showSeatMapError('Failed to load seat map. Please try again.');
                }
            });
    }
    
    function showSeatMapError(message) {
        const seatMapContainer = document.getElementById('seatMap');
        const isLoginError = message.includes('login');
        
        seatMapContainer.innerHTML = `
            <div class="seat-map-error">
                <i class="fas fa-exclamation-triangle"></i>
                <p>${message}</p>
                ${isLoginError ? 
                    '<a href="/login" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> Login</a>' :
                    '<button onclick="loadSeatMap()" class="btn btn-outline-primary"><i class="fas fa-refresh"></i> Retry</button>'
                }
            </div>
        `;
    }
    
    function renderSeatMap(seatMap, occupiedSeats) {
        const seatMapContainer = document.getElementById('seatMap');
        if (!seatMapContainer) {
            console.error('Seat map container not found!');
            return;
        }
        
        seatMapContainer.innerHTML = '';
        
        // Group seats by row
        const rows = {};
        seatMap.forEach(seat => {
            if (!rows[seat.row_number]) {
                rows[seat.row_number] = [];
            }
            rows[seat.row_number].push(seat);
        });
        
        // Sort rows and render
        Object.keys(rows).sort().forEach(rowNumber => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'seat-row';
            
            // Add row label
            const rowLabel = document.createElement('div');
            rowLabel.className = 'row-label';
            rowLabel.textContent = rowNumber;
            rowDiv.appendChild(rowLabel);
            
            // Add seats
            rows[rowNumber].forEach(seat => {
                const seatElement = document.createElement('div');
                seatElement.className = 'seat';
                seatElement.dataset.seatId = seat.seat_id;
                seatElement.dataset.seatType = seat.seat_type;
                seatElement.dataset.price = seat.price;
                seatElement.textContent = seat.seat_number;
                
                // Check if seat is occupied
                if (occupiedSeats.includes(seat.seat_id)) {
                    seatElement.classList.add('occupied');
                } else {
                    seatElement.classList.add('available');
                    seatElement.addEventListener('click', () => toggleSeat(seatElement));
                }
                
                // Add seat type styling
                seatElement.classList.add(seat.seat_type);
                
                rowDiv.appendChild(seatElement);
            });
            
            seatMapContainer.appendChild(rowDiv);
        });
    }
    
    function toggleSeat(seatElement) {
        const seatId = parseInt(seatElement.dataset.seatId);
        const seatType = seatElement.dataset.seatType;
        const price = parseFloat(seatElement.dataset.price);
        
        if (seatElement.classList.contains('selected')) {
            // Deselect seat
            seatElement.classList.remove('selected');
            seatElement.classList.add('available');
            selectedSeats = selectedSeats.filter(seat => seat.seat_id !== seatId);
        } else {
            // Select seat
            seatElement.classList.remove('available');
            seatElement.classList.add('selected');
            selectedSeats.push({
                seat_id: seatId,
                seat_label: `${seatElement.parentElement.querySelector('.row-label').textContent}${seatElement.textContent}`,
                seat_type: seatType,
                price: price
            });
        }
        
        updateBookingSummary();
    }
    
    function updateBookingSummary() {
        const selectedSeatsList = document.getElementById('selectedSeatsList');
        const totalPriceElement = document.getElementById('totalPrice');
        const bookButton = document.getElementById('bookButton');
        
        // Update selected seats list
        selectedSeatsList.innerHTML = '';
        if (selectedSeats.length === 0) {
            selectedSeatsList.innerHTML = '<p class="text-muted">No seats selected</p>';
        } else {
            selectedSeats.forEach(seat => {
                const seatDiv = document.createElement('div');
                seatDiv.className = 'selected-seat-item';
                seatDiv.innerHTML = `
                    <span class="seat-label">${seat.seat_label}</span>
                    <span class="seat-type">${seat.seat_type.toUpperCase()}</span>
                    <span class="seat-price">$${seat.price.toFixed(2)}</span>
                `;
                selectedSeatsList.appendChild(seatDiv);
            });
        }
        
        // Update total price
        const totalPrice = selectedSeats.reduce((sum, seat) => sum + seat.price, 0);
        totalPriceElement.textContent = `$${totalPrice.toFixed(2)}`;
        
        // Enable/disable book button
        bookButton.disabled = selectedSeats.length === 0;
    }
    
    // Handle booking form submission
    document.getElementById('bookButton').addEventListener('click', function() {
        if (selectedSeats.length === 0) {
            alert('Please select at least one seat.');
            return;
        }
        
        const form = document.getElementById('bookingForm');
        document.getElementById('selectedSeatsInput').value = JSON.stringify(selectedSeats);
        document.getElementById('totalAmountInput').value = selectedSeats.reduce((sum, seat) => sum + seat.price, 0);
        
        const formData = new FormData(form);
        
        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Booking successful! Your booking number is: ' + data.booking_number);
                window.location.href = '/bookings';
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to complete booking. Please try again.');
        });
    });
});
</script>
{% endblock %}
